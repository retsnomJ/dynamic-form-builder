# 动态表单升级计划

## 目标场景
实现一个高级动态表单，支持：
- 产品字段：下拉框，从API获取选项
- 联动事件：选择产品时，自动填充产品图号和产品名称
- 完全动态配置：所有行为通过数据接口配置

## 一、数据接口扩展方案

### 1.1 字段配置扩展

在现有字段配置基础上，需要添加以下属性：

```json
{
  "fieldName": "productId",
  "fieldType": "select",
  "fieldLabel": "产品",
  "visible": true,
  "editable": true,
  "required": true,
  
  // 新增：数据源配置
  "dataSource": {
    "type": "api",
    "url": "/api/products/list",
    "method": "GET",
    "params": {},
    "valueField": "id",
    "labelField": "name",
    "cache": true,
    "cacheTime": 300000
  },
  
  // 新增：事件配置
  "events": [
    {
      "type": "change",
      "actions": [
        {
          "type": "setValue",
          "targetField": "drawcode",
          "sourceExpression": "selectedOption.drawcode"
        },
        {
          "type": "setValue", 
          "targetField": "productName",
          "sourceExpression": "selectedOption.name"
        }
      ]
    }
  ],
  
  // 新增：组件特定配置
  "componentConfig": {
    "placeholder": "请选择产品",
    "clearable": true,
    "filterable": true
  }
}
```

### 1.2 支持的字段类型扩展

| 类型 | 组件 | 数据源支持 | 事件支持 |
|------|------|-----------|----------|
| `string` | el-input | ❌ | ✅ |
| `integer` | el-input-number | ❌ | ✅ |
| `float` | el-input-number | ❌ | ✅ |
| `date` | el-date-picker | ❌ | ✅ |
| `select` | el-select | ✅ | ✅ |
| `radio` | el-radio-group | ✅ | ✅ |
| `checkbox` | el-checkbox-group | ✅ | ✅ |

### 1.3 数据源配置类型

```typescript
interface DataSource {
  type: 'api' | 'static' | 'computed';
  
  // API数据源
  url?: string;
  method?: 'GET' | 'POST';
  params?: Record<string, any>;
  headers?: Record<string, string>;
  
  // 静态数据源
  options?: Array<{value: any, label: string, [key: string]: any}>;
  
  // 计算数据源
  expression?: string;
  
  // 通用配置
  valueField: string;
  labelField: string;
  cache?: boolean;
  cacheTime?: number;
}
```

### 1.4 事件配置类型

```typescript
interface FieldEvent {
  type: 'change' | 'focus' | 'blur' | 'input';
  condition?: string; // 触发条件表达式
  actions: EventAction[];
}

interface EventAction {
  type: 'setValue' | 'callApi' | 'validate' | 'show' | 'hide' | 'enable' | 'disable';
  targetField?: string;
  sourceExpression?: string;
  value?: any;
  apiConfig?: {
    url: string;
    method: string;
    params?: Record<string, any>;
  };
}
```

## 二、实现步骤规划

### 阶段一：基础架构升级 (1-2天)

#### 步骤1：扩展字段类型支持
- [ ] 添加 `select` 字段类型支持
- [ ] 创建动态组件渲染器
- [ ] 实现组件配置传递机制

#### 步骤2：数据源管理系统
- [ ] 创建 `DataSourceManager` 类
- [ ] 实现API数据源加载
- [ ] 添加缓存机制
- [ ] 处理加载状态和错误

### 阶段二：事件系统实现 (2-3天)

#### 步骤3：事件管理器
- [ ] 创建 `EventManager` 类
- [ ] 实现事件注册和触发机制
- [ ] 支持表达式解析

#### 步骤4：字段联动实现
- [ ] 实现 `setValue` 动作
- [ ] 支持复杂表达式计算
- [ ] 处理循环依赖检测

### 阶段三：高级功能 (1-2天)

#### 步骤5：表达式引擎
- [ ] 实现安全的表达式解析器
- [ ] 支持字段引用和选项数据访问
- [ ] 添加常用函数库

#### 步骤6：用户体验优化
- [ ] 加载状态显示
- [ ] 错误处理和提示
- [ ] 性能优化

## 三、核心代码架构

### 3.1 组件结构
```
DynamicForm/
├── components/
│   ├── DynamicField.vue      # 动态字段渲染器
│   ├── SelectField.vue       # 下拉框组件
│   └── ...
├── managers/
│   ├── DataSourceManager.ts  # 数据源管理
│   ├── EventManager.ts       # 事件管理
│   └── ExpressionEngine.ts   # 表达式引擎
└── types/
    └── form-config.ts        # 类型定义
```

### 3.2 关键接口设计

```typescript
// 表单配置
interface FormConfig {
  fields: FieldConfig[];
  layout?: LayoutConfig;
  validation?: ValidationConfig;
}

// 字段配置
interface FieldConfig {
  fieldName: string;
  fieldType: string;
  fieldLabel: string;
  visible?: boolean;
  editable?: boolean;
  required?: boolean;
  dataSource?: DataSource;
  events?: FieldEvent[];
  componentConfig?: Record<string, any>;
}
```

## 四、示例配置

### 4.1 产品选择联动示例

```json
[
  {
    "fieldName": "productId",
    "fieldType": "select",
    "fieldLabel": "产品",
    "required": true,
    "dataSource": {
      "type": "api",
      "url": "/api/products",
      "valueField": "id",
      "labelField": "name"
    },
    "events": [
      {
        "type": "change",
        "actions": [
          {
            "type": "setValue",
            "targetField": "drawcode",
            "sourceExpression": "selectedOption.drawcode"
          },
          {
            "type": "setValue",
            "targetField": "productName", 
            "sourceExpression": "selectedOption.name"
          }
        ]
      }
    ]
  },
  {
    "fieldName": "drawcode",
    "fieldType": "string",
    "fieldLabel": "产品图号",
    "editable": false
  },
  {
    "fieldName": "productName",
    "fieldType": "string", 
    "fieldLabel": "产品名称",
    "editable": false
  }
]
```

## 五、技术难点和解决方案

### 5.1 表达式安全性
- 使用白名单机制限制可访问的对象和方法
- 实现沙箱环境执行表达式
- 防止XSS和代码注入

### 5.2 性能优化
- 数据源缓存机制
- 事件防抖处理
- 虚拟滚动（大数据量）
- 按需加载组件

### 5.3 错误处理
- 数据源加载失败处理
- 表达式执行错误捕获
- 用户友好的错误提示

## 六、测试策略

1. **单元测试**: 各个管理器类的功能测试
2. **集成测试**: 字段联动和数据流测试
3. **端到端测试**: 完整用户场景测试
4. **性能测试**: 大量字段和复杂联动的性能测试

这个升级计划将把你的动态表单从简单的字段渲染提升到一个功能完整的动态表单系统。